<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Extraction Service</title>
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="contact">
                    Fellowship Greenville - For assistance, email: <a href="mailto:mmeekins@fellowshipgreenville.org">mmeekins@fellowshipgreenville.org</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <h1><span class="icon icon-file"></span> Text Extraction Service</h1>
                <p class="subtitle">Upload ZIP files containing .txt files or select individual .txt files to extract structured data into CSV format</p>
            </div>
        </div>

        <div class="container content">
            <!-- Upload Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">
                        <span class="icon icon-upload"></span>
                    </div>
                    <h2 class="section-title">File Upload</h2>
                </div>

                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" name="files" accept=".zip,.txt" multiple style="display: none;">
                        <div class="upload-icon">
                            <span class="icon icon-upload"></span>
                        </div>
                        <p class="upload-text">Click to select files or drag and drop</p>
                        <p class="upload-subtext">Accepted: ZIP files or multiple TXT files</p>
                        <p class="upload-subtext">Maximum file size: 500MB</p>
                    </div>
                    
                    <div id="fileList" class="file-list"></div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span class="icon icon-processing"></span> Process Files
                        </button>
                    </div>
                </form>
            </div>

            <!-- Progress Section -->
            <div id="progress" class="progress">
                <div class="progress-text">
                    <div class="progress-spinner"></div>
                    Processing your files...
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="result"></div>
        </div>
    </main>
            
            <script>
                let selectedFiles = [];
                
                function formatFileSize(bytes) {
                    if (bytes < 1024) {
                        return bytes + ' B';
                    } else if (bytes < 1024 * 1024) {
                        return (bytes / 1024).toFixed(1) + ' KB';
                    } else {
                        return (bytes / 1024 / 1024).toFixed(1) + ' MB';
                    }
                }
                
                function updateFileList() {
                    const fileList = document.getElementById('fileList');
                    const submitBtn = document.querySelector('button[type="submit"]');
                    const uploadArea = document.querySelector('.upload-area');
                    
                    if (selectedFiles.length === 0) {
                        fileList.innerHTML = '';
                        submitBtn.disabled = true;
                        uploadArea.innerHTML = `
                            <div class="upload-icon">
                                <span class="icon icon-upload"></span>
                            </div>
                            <p class="upload-text">Click to select files or drag and drop</p>
                            <p class="upload-subtext">Accepted: ZIP files or multiple TXT files</p>
                            <p class="upload-subtext">Maximum file size: 500MB</p>
                        `;
                        return;
                    }
                    
                    submitBtn.disabled = false;
                    uploadArea.innerHTML = `
                        <div class="upload-icon">
                            <span class="icon icon-check"></span>
                        </div>
                        <p class="upload-text">Files selected - click here to select different files</p>
                    `;
                    
                    fileList.innerHTML = selectedFiles.map((file, index) => 
                        `<div class="file-item">
                            <div class="file-info">
                                <div class="file-icon">
                                    <span class="icon icon-file"></span>
                                </div>
                                <div>
                                    <div class="file-name">${file.name} <span class="file-size">(${formatFileSize(file.size)})</span></div>
                                </div>
                            </div>
                            <button type="button" class="file-remove" onclick="removeFile(${index})">Ã—</button>
                        </div>`
                    ).join('');
                }
                
                function removeFile(index) {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                }
                
                document.getElementById('uploadForm').onsubmit = async function(e) {
                    e.preventDefault();
                    
                    const progressDiv = document.getElementById('progress');
                    const resultDiv = document.getElementById('result');
                    
                    if (selectedFiles.length === 0) {
                        alert('Please select files to process');
                        return;
                    }
                    
                    progressDiv.classList.add('show');
                    resultDiv.innerHTML = '';
                    
                    const formData = new FormData();
                    selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    try {
                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'extracted_data.csv';
                            a.click();
                            
                            resultDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <span class="icon icon-check"></span> Processing complete! CSV file downloaded.
                                </div>
                            `;
                        } else {
                            const error = await response.text();
                            resultDiv.innerHTML = `
                                <div class="alert alert-error">
                                    <span class="icon icon-error"></span> Error: ${error}
                                </div>
                            `;
                        }
                    } catch (error) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-error">
                                <span class="icon icon-error"></span> Error: ${error.message}
                            </div>
                        `;
                    }
                    
                    progressDiv.classList.remove('show');
                };
                
                // Handle drag and drop
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                // Add click handler
                uploadArea.onclick = function() {
                    fileInput.click();
                };
                
                uploadArea.ondragover = (e) => { 
                    e.preventDefault(); 
                    uploadArea.classList.add('active');
                };
                uploadArea.ondragleave = () => { 
                    uploadArea.classList.remove('active');
                };
                uploadArea.ondrop = (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('active');
                    if (e.dataTransfer.files.length > 0) {
                        selectedFiles = Array.from(e.dataTransfer.files);
                        updateFileList();
                    }
                };
                
                fileInput.onchange = function() {
                    if (this.files.length > 0) {
                        selectedFiles = Array.from(this.files);
                        updateFileList();
                    }
                };
                
                // Initialize
                updateFileList();
            </script>
        </body>
        </html>
